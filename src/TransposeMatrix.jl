module TransposeMatrix

using SIMD

export transpose2x2!
function transpose2x2!(B::DenseMatrix{UInt8}, A::DenseMatrix{UInt8})
    @assert size(A) == (2, 2)
    @assert size(B) == (2, 2)
    @assert stride(A, 1) == 1
    @assert stride(B, 1) == 1

    @inbounds begin
        a0 = vload(Vec{2,UInt8}, view(A, :, 1), 1)
        a1 = vload(Vec{2,UInt8}, view(A, :, 2), 1)

        b0 = shufflevector(a0, a1, Val((0, 2)))
        b1 = shufflevector(a0, a1, Val((1, 3)))

        vstore(b0, view(B, :, 1), 1)
        vstore(b1, view(B, :, 2), 1)
    end

    nothing
end

export transpose4x4!
function transpose4x4!(B::DenseMatrix{UInt8}, A::DenseMatrix{UInt8})
    @assert size(A) == (4, 4)
    @assert size(B) == (4, 4)
    @assert stride(A, 1) == 1
    @assert stride(B, 1) == 1

    @inbounds begin
        a0 = vload(Vec{4,UInt8}, view(A, :, 1), 1)
        a1 = vload(Vec{4,UInt8}, view(A, :, 2), 1)
        a2 = vload(Vec{4,UInt8}, view(A, :, 3), 1)
        a3 = vload(Vec{4,UInt8}, view(A, :, 4), 1)

        b0 = shufflevector(a0, a2, Val((0, 1, 4, 5)))
        b1 = shufflevector(a1, a3, Val((0, 1, 4, 5)))
        b2 = shufflevector(a0, a2, Val((2, 3, 6, 7)))
        b3 = shufflevector(a1, a3, Val((2, 3, 6, 7)))

        c0 = shufflevector(b0, b1, Val((0, 4, 2, 6)))
        c1 = shufflevector(b0, b1, Val((1, 5, 3, 7)))
        c2 = shufflevector(b2, b3, Val((0, 4, 2, 6)))
        c3 = shufflevector(b2, b3, Val((1, 5, 3, 7)))

        vstore(c0, view(B, :, 1), 1)
        vstore(c1, view(B, :, 2), 1)
        vstore(c2, view(B, :, 3), 1)
        vstore(c3, view(B, :, 4), 1)
    end

    nothing
end

export transpose8x8!
function transpose8x8!(B::DenseMatrix{UInt8}, A::DenseMatrix{UInt8})
    @assert size(A) == (8, 8)
    @assert size(B) == (8, 8)
    @assert stride(A, 1) == 1
    @assert stride(B, 1) == 1

    @inbounds begin
        a0 = vload(Vec{8,UInt8}, view(A, :, 0x0 + 0x1), 0x1)
        a1 = vload(Vec{8,UInt8}, view(A, :, 0x1 + 0x1), 0x1)
        a2 = vload(Vec{8,UInt8}, view(A, :, 0x2 + 0x1), 0x1)
        a3 = vload(Vec{8,UInt8}, view(A, :, 0x3 + 0x1), 0x1)
        a4 = vload(Vec{8,UInt8}, view(A, :, 0x4 + 0x1), 0x1)
        a5 = vload(Vec{8,UInt8}, view(A, :, 0x5 + 0x1), 0x1)
        a6 = vload(Vec{8,UInt8}, view(A, :, 0x6 + 0x1), 0x1)
        a7 = vload(Vec{8,UInt8}, view(A, :, 0x7 + 0x1), 0x1)

        b0 = shufflevector(a0, a4, Val((0x0, 0x1, 0x2, 0x3, 0x8, 0x9, 0xa, 0xb)))
        b1 = shufflevector(a1, a5, Val((0x0, 0x1, 0x2, 0x3, 0x8, 0x9, 0xa, 0xb)))
        b2 = shufflevector(a2, a6, Val((0x0, 0x1, 0x2, 0x3, 0x8, 0x9, 0xa, 0xb)))
        b3 = shufflevector(a3, a7, Val((0x0, 0x1, 0x2, 0x3, 0x8, 0x9, 0xa, 0xb)))
        b4 = shufflevector(a0, a4, Val((0x4, 0x5, 0x6, 0x7, 0xc, 0xd, 0xe, 0xf)))
        b5 = shufflevector(a1, a5, Val((0x4, 0x5, 0x6, 0x7, 0xc, 0xd, 0xe, 0xf)))
        b6 = shufflevector(a2, a6, Val((0x4, 0x5, 0x6, 0x7, 0xc, 0xd, 0xe, 0xf)))
        b7 = shufflevector(a3, a7, Val((0x4, 0x5, 0x6, 0x7, 0xc, 0xd, 0xe, 0xf)))

        c0 = shufflevector(b0, b2, Val((0x0, 0x1, 0x8, 0x9, 0x4, 0x5, 0xc, 0xd)))
        c1 = shufflevector(b1, b3, Val((0x0, 0x1, 0x8, 0x9, 0x4, 0x5, 0xc, 0xd)))
        c2 = shufflevector(b0, b2, Val((0x2, 0x3, 0xa, 0xb, 0x6, 0x7, 0xe, 0xf)))
        c3 = shufflevector(b1, b3, Val((0x2, 0x3, 0xa, 0xb, 0x6, 0x7, 0xe, 0xf)))
        c4 = shufflevector(b4, b6, Val((0x0, 0x1, 0x8, 0x9, 0x4, 0x5, 0xc, 0xd)))
        c5 = shufflevector(b5, b7, Val((0x0, 0x1, 0x8, 0x9, 0x4, 0x5, 0xc, 0xd)))
        c6 = shufflevector(b4, b6, Val((0x2, 0x3, 0xa, 0xb, 0x6, 0x7, 0xe, 0xf)))
        c7 = shufflevector(b5, b7, Val((0x2, 0x3, 0xa, 0xb, 0x6, 0x7, 0xe, 0xf)))

        d0 = shufflevector(c0, c1, Val((0x0, 0x8, 0x2, 0xa, 0x4, 0xc, 0x6, 0xe)))
        d1 = shufflevector(c0, c1, Val((0x1, 0x9, 0x3, 0xb, 0x5, 0xd, 0x7, 0xf)))
        d2 = shufflevector(c2, c3, Val((0x0, 0x8, 0x2, 0xa, 0x4, 0xc, 0x6, 0xe)))
        d3 = shufflevector(c2, c3, Val((0x1, 0x9, 0x3, 0xb, 0x5, 0xd, 0x7, 0xf)))
        d4 = shufflevector(c4, c5, Val((0x0, 0x8, 0x2, 0xa, 0x4, 0xc, 0x6, 0xe)))
        d5 = shufflevector(c4, c5, Val((0x1, 0x9, 0x3, 0xb, 0x5, 0xd, 0x7, 0xf)))
        d6 = shufflevector(c6, c7, Val((0x0, 0x8, 0x2, 0xa, 0x4, 0xc, 0x6, 0xe)))
        d7 = shufflevector(c6, c7, Val((0x1, 0x9, 0x3, 0xb, 0x5, 0xd, 0x7, 0xf)))

        vstore(d0, view(B, :, 0x0 + 0x1), 0x1)
        vstore(d1, view(B, :, 0x1 + 0x1), 0x1)
        vstore(d2, view(B, :, 0x2 + 0x1), 0x1)
        vstore(d3, view(B, :, 0x3 + 0x1), 0x1)
        vstore(d4, view(B, :, 0x4 + 0x1), 0x1)
        vstore(d5, view(B, :, 0x5 + 0x1), 0x1)
        vstore(d6, view(B, :, 0x6 + 0x1), 0x1)
        vstore(d7, view(B, :, 0x7 + 0x1), 0x1)
    end

    nothing
end

export transpose16x16!
function transpose16x16!(B::DenseMatrix{UInt8}, A::DenseMatrix{UInt8})
    @assert size(A) == (16, 16)
    @assert size(B) == (16, 16)
    @assert stride(A, 1) == 1
    @assert stride(B, 1) == 1

    @inbounds begin
        a0 = vload(Vec{16,UInt8}, view(A, :, 0x0 + 0x1), 0x1)
        a1 = vload(Vec{16,UInt8}, view(A, :, 0x1 + 0x1), 0x1)
        a2 = vload(Vec{16,UInt8}, view(A, :, 0x2 + 0x1), 0x1)
        a3 = vload(Vec{16,UInt8}, view(A, :, 0x3 + 0x1), 0x1)
        a4 = vload(Vec{16,UInt8}, view(A, :, 0x4 + 0x1), 0x1)
        a5 = vload(Vec{16,UInt8}, view(A, :, 0x5 + 0x1), 0x1)
        a6 = vload(Vec{16,UInt8}, view(A, :, 0x6 + 0x1), 0x1)
        a7 = vload(Vec{16,UInt8}, view(A, :, 0x7 + 0x1), 0x1)
        a8 = vload(Vec{16,UInt8}, view(A, :, 0x8 + 0x1), 0x1)
        a9 = vload(Vec{16,UInt8}, view(A, :, 0x9 + 0x1), 0x1)
        aa = vload(Vec{16,UInt8}, view(A, :, 0xa + 0x1), 0x1)
        ab = vload(Vec{16,UInt8}, view(A, :, 0xb + 0x1), 0x1)
        ac = vload(Vec{16,UInt8}, view(A, :, 0xc + 0x1), 0x1)
        ad = vload(Vec{16,UInt8}, view(A, :, 0xd + 0x1), 0x1)
        ae = vload(Vec{16,UInt8}, view(A, :, 0xe + 0x1), 0x1)
        af = vload(Vec{16,UInt8}, view(A, :, 0xf + 0x1), 0x1)

        b0 = shufflevector(
            a0, a8, Val((0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17))
        )
        b1 = shufflevector(
            a1, a9, Val((0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17))
        )
        b2 = shufflevector(
            a2, aa, Val((0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17))
        )
        b3 = shufflevector(
            a3, ab, Val((0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17))
        )
        b4 = shufflevector(
            a4, ac, Val((0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17))
        )
        b5 = shufflevector(
            a5, ad, Val((0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17))
        )
        b6 = shufflevector(
            a6, ae, Val((0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17))
        )
        b7 = shufflevector(
            a7, af, Val((0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17))
        )
        b8 = shufflevector(
            a0, a8, Val((0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f, 0x18, 0x19, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f))
        )
        b9 = shufflevector(
            a1, a9, Val((0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f, 0x18, 0x19, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f))
        )
        ba = shufflevector(
            a2, aa, Val((0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f, 0x18, 0x19, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f))
        )
        bb = shufflevector(
            a3, ab, Val((0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f, 0x18, 0x19, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f))
        )
        bc = shufflevector(
            a4, ac, Val((0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f, 0x18, 0x19, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f))
        )
        bd = shufflevector(
            a5, ad, Val((0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f, 0x18, 0x19, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f))
        )
        be = shufflevector(
            a6, ae, Val((0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f, 0x18, 0x19, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f))
        )
        bf = shufflevector(
            a7, af, Val((0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f, 0x18, 0x19, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f))
        )

        c0 = shufflevector(
            b0, b4, Val((0x00, 0x01, 0x02, 0x03, 0x10, 0x11, 0x12, 0x13, 0x08, 0x09, 0x0a, 0x0b, 0x18, 0x19, 0x1a, 0x1b))
        )
        c1 = shufflevector(
            b1, b5, Val((0x00, 0x01, 0x02, 0x03, 0x10, 0x11, 0x12, 0x13, 0x08, 0x09, 0x0a, 0x0b, 0x18, 0x19, 0x1a, 0x1b))
        )
        c2 = shufflevector(
            b2, b6, Val((0x00, 0x01, 0x02, 0x03, 0x10, 0x11, 0x12, 0x13, 0x08, 0x09, 0x0a, 0x0b, 0x18, 0x19, 0x1a, 0x1b))
        )
        c3 = shufflevector(
            b3, b7, Val((0x00, 0x01, 0x02, 0x03, 0x10, 0x11, 0x12, 0x13, 0x08, 0x09, 0x0a, 0x0b, 0x18, 0x19, 0x1a, 0x1b))
        )
        c4 = shufflevector(
            b0, b4, Val((0x04, 0x05, 0x06, 0x07, 0x14, 0x15, 0x16, 0x17, 0x0c, 0x0d, 0x0e, 0x0f, 0x1c, 0x1d, 0x1e, 0x1f))
        )
        c5 = shufflevector(
            b1, b5, Val((0x04, 0x05, 0x06, 0x07, 0x14, 0x15, 0x16, 0x17, 0x0c, 0x0d, 0x0e, 0x0f, 0x1c, 0x1d, 0x1e, 0x1f))
        )
        c6 = shufflevector(
            b2, b6, Val((0x04, 0x05, 0x06, 0x07, 0x14, 0x15, 0x16, 0x17, 0x0c, 0x0d, 0x0e, 0x0f, 0x1c, 0x1d, 0x1e, 0x1f))
        )
        c7 = shufflevector(
            b3, b7, Val((0x04, 0x05, 0x06, 0x07, 0x14, 0x15, 0x16, 0x17, 0x0c, 0x0d, 0x0e, 0x0f, 0x1c, 0x1d, 0x1e, 0x1f))
        )
        c8 = shufflevector(
            b8, bc, Val((0x00, 0x01, 0x02, 0x03, 0x10, 0x11, 0x12, 0x13, 0x08, 0x09, 0x0a, 0x0b, 0x18, 0x19, 0x1a, 0x1b))
        )
        c9 = shufflevector(
            b9, bd, Val((0x00, 0x01, 0x02, 0x03, 0x10, 0x11, 0x12, 0x13, 0x08, 0x09, 0x0a, 0x0b, 0x18, 0x19, 0x1a, 0x1b))
        )
        ca = shufflevector(
            ba, be, Val((0x00, 0x01, 0x02, 0x03, 0x10, 0x11, 0x12, 0x13, 0x08, 0x09, 0x0a, 0x0b, 0x18, 0x19, 0x1a, 0x1b))
        )
        cb = shufflevector(
            bb, bf, Val((0x00, 0x01, 0x02, 0x03, 0x10, 0x11, 0x12, 0x13, 0x08, 0x09, 0x0a, 0x0b, 0x18, 0x19, 0x1a, 0x1b))
        )
        cc = shufflevector(
            b8, bc, Val((0x04, 0x05, 0x06, 0x07, 0x14, 0x15, 0x16, 0x17, 0x0c, 0x0d, 0x0e, 0x0f, 0x1c, 0x1d, 0x1e, 0x1f))
        )
        cd = shufflevector(
            b9, bd, Val((0x04, 0x05, 0x06, 0x07, 0x14, 0x15, 0x16, 0x17, 0x0c, 0x0d, 0x0e, 0x0f, 0x1c, 0x1d, 0x1e, 0x1f))
        )
        ce = shufflevector(
            ba, be, Val((0x04, 0x05, 0x06, 0x07, 0x14, 0x15, 0x16, 0x17, 0x0c, 0x0d, 0x0e, 0x0f, 0x1c, 0x1d, 0x1e, 0x1f))
        )
        cf = shufflevector(
            bb, bf, Val((0x04, 0x05, 0x06, 0x07, 0x14, 0x15, 0x16, 0x17, 0x0c, 0x0d, 0x0e, 0x0f, 0x1c, 0x1d, 0x1e, 0x1f))
        )

        d0 = shufflevector(
            c0, c2, Val((0x00, 0x01, 0x10, 0x11, 0x04, 0x05, 0x14, 0x15, 0x08, 0x09, 0x18, 0x19, 0x0c, 0x0d, 0x1c, 0x1d))
        )
        d1 = shufflevector(
            c1, c3, Val((0x00, 0x01, 0x10, 0x11, 0x04, 0x05, 0x14, 0x15, 0x08, 0x09, 0x18, 0x19, 0x0c, 0x0d, 0x1c, 0x1d))
        )
        d2 = shufflevector(
            c0, c2, Val((0x02, 0x03, 0x12, 0x13, 0x06, 0x07, 0x16, 0x17, 0x0a, 0x0b, 0x1a, 0x1b, 0x0e, 0x0f, 0x1e, 0x1f))
        )
        d3 = shufflevector(
            c1, c3, Val((0x02, 0x03, 0x12, 0x13, 0x06, 0x07, 0x16, 0x17, 0x0a, 0x0b, 0x1a, 0x1b, 0x0e, 0x0f, 0x1e, 0x1f))
        )
        d4 = shufflevector(
            c4, c6, Val((0x00, 0x01, 0x10, 0x11, 0x04, 0x05, 0x14, 0x15, 0x08, 0x09, 0x18, 0x19, 0x0c, 0x0d, 0x1c, 0x1d))
        )
        d5 = shufflevector(
            c5, c7, Val((0x00, 0x01, 0x10, 0x11, 0x04, 0x05, 0x14, 0x15, 0x08, 0x09, 0x18, 0x19, 0x0c, 0x0d, 0x1c, 0x1d))
        )
        d6 = shufflevector(
            c4, c6, Val((0x02, 0x03, 0x12, 0x13, 0x06, 0x07, 0x16, 0x17, 0x0a, 0x0b, 0x1a, 0x1b, 0x0e, 0x0f, 0x1e, 0x1f))
        )
        d7 = shufflevector(
            c5, c7, Val((0x02, 0x03, 0x12, 0x13, 0x06, 0x07, 0x16, 0x17, 0x0a, 0x0b, 0x1a, 0x1b, 0x0e, 0x0f, 0x1e, 0x1f))
        )
        d8 = shufflevector(
            c8, ca, Val((0x00, 0x01, 0x10, 0x11, 0x04, 0x05, 0x14, 0x15, 0x08, 0x09, 0x18, 0x19, 0x0c, 0x0d, 0x1c, 0x1d))
        )
        d9 = shufflevector(
            c9, cb, Val((0x00, 0x01, 0x10, 0x11, 0x04, 0x05, 0x14, 0x15, 0x08, 0x09, 0x18, 0x19, 0x0c, 0x0d, 0x1c, 0x1d))
        )
        da = shufflevector(
            c8, ca, Val((0x02, 0x03, 0x12, 0x13, 0x06, 0x07, 0x16, 0x17, 0x0a, 0x0b, 0x1a, 0x1b, 0x0e, 0x0f, 0x1e, 0x1f))
        )
        db = shufflevector(
            c9, cb, Val((0x02, 0x03, 0x12, 0x13, 0x06, 0x07, 0x16, 0x17, 0x0a, 0x0b, 0x1a, 0x1b, 0x0e, 0x0f, 0x1e, 0x1f))
        )
        dc = shufflevector(
            cc, ce, Val((0x00, 0x01, 0x10, 0x11, 0x04, 0x05, 0x14, 0x15, 0x08, 0x09, 0x18, 0x19, 0x0c, 0x0d, 0x1c, 0x1d))
        )
        dd = shufflevector(
            cd, cf, Val((0x00, 0x01, 0x10, 0x11, 0x04, 0x05, 0x14, 0x15, 0x08, 0x09, 0x18, 0x19, 0x0c, 0x0d, 0x1c, 0x1d))
        )
        de = shufflevector(
            cc, ce, Val((0x02, 0x03, 0x12, 0x13, 0x06, 0x07, 0x16, 0x17, 0x0a, 0x0b, 0x1a, 0x1b, 0x0e, 0x0f, 0x1e, 0x1f))
        )
        df = shufflevector(
            cd, cf, Val((0x02, 0x03, 0x12, 0x13, 0x06, 0x07, 0x16, 0x17, 0x0a, 0x0b, 0x1a, 0x1b, 0x0e, 0x0f, 0x1e, 0x1f))
        )

        e0 = shufflevector(
            d0, d1, Val((0x00, 0x10, 0x02, 0x12, 0x04, 0x14, 0x06, 0x16, 0x08, 0x18, 0x0a, 0x1a, 0x0c, 0x1c, 0x0e, 0x1e))
        )
        e1 = shufflevector(
            d0, d1, Val((0x01, 0x11, 0x03, 0x13, 0x05, 0x15, 0x07, 0x17, 0x09, 0x19, 0x0b, 0x1b, 0x0d, 0x1d, 0x0f, 0x1f))
        )
        e2 = shufflevector(
            d2, d3, Val((0x00, 0x10, 0x02, 0x12, 0x04, 0x14, 0x06, 0x16, 0x08, 0x18, 0x0a, 0x1a, 0x0c, 0x1c, 0x0e, 0x1e))
        )
        e3 = shufflevector(
            d2, d3, Val((0x01, 0x11, 0x03, 0x13, 0x05, 0x15, 0x07, 0x17, 0x09, 0x19, 0x0b, 0x1b, 0x0d, 0x1d, 0x0f, 0x1f))
        )
        e4 = shufflevector(
            d4, d5, Val((0x00, 0x10, 0x02, 0x12, 0x04, 0x14, 0x06, 0x16, 0x08, 0x18, 0x0a, 0x1a, 0x0c, 0x1c, 0x0e, 0x1e))
        )
        e5 = shufflevector(
            d4, d5, Val((0x01, 0x11, 0x03, 0x13, 0x05, 0x15, 0x07, 0x17, 0x09, 0x19, 0x0b, 0x1b, 0x0d, 0x1d, 0x0f, 0x1f))
        )
        e6 = shufflevector(
            d6, d7, Val((0x00, 0x10, 0x02, 0x12, 0x04, 0x14, 0x06, 0x16, 0x08, 0x18, 0x0a, 0x1a, 0x0c, 0x1c, 0x0e, 0x1e))
        )
        e7 = shufflevector(
            d6, d7, Val((0x01, 0x11, 0x03, 0x13, 0x05, 0x15, 0x07, 0x17, 0x09, 0x19, 0x0b, 0x1b, 0x0d, 0x1d, 0x0f, 0x1f))
        )
        e8 = shufflevector(
            d8, d9, Val((0x00, 0x10, 0x02, 0x12, 0x04, 0x14, 0x06, 0x16, 0x08, 0x18, 0x0a, 0x1a, 0x0c, 0x1c, 0x0e, 0x1e))
        )
        e9 = shufflevector(
            d8, d9, Val((0x01, 0x11, 0x03, 0x13, 0x05, 0x15, 0x07, 0x17, 0x09, 0x19, 0x0b, 0x1b, 0x0d, 0x1d, 0x0f, 0x1f))
        )
        ea = shufflevector(
            da, db, Val((0x00, 0x10, 0x02, 0x12, 0x04, 0x14, 0x06, 0x16, 0x08, 0x18, 0x0a, 0x1a, 0x0c, 0x1c, 0x0e, 0x1e))
        )
        eb = shufflevector(
            da, db, Val((0x01, 0x11, 0x03, 0x13, 0x05, 0x15, 0x07, 0x17, 0x09, 0x19, 0x0b, 0x1b, 0x0d, 0x1d, 0x0f, 0x1f))
        )
        ec = shufflevector(
            dc, dd, Val((0x00, 0x10, 0x02, 0x12, 0x04, 0x14, 0x06, 0x16, 0x08, 0x18, 0x0a, 0x1a, 0x0c, 0x1c, 0x0e, 0x1e))
        )
        ed = shufflevector(
            dc, dd, Val((0x01, 0x11, 0x03, 0x13, 0x05, 0x15, 0x07, 0x17, 0x09, 0x19, 0x0b, 0x1b, 0x0d, 0x1d, 0x0f, 0x1f))
        )
        ee = shufflevector(
            de, df, Val((0x00, 0x10, 0x02, 0x12, 0x04, 0x14, 0x06, 0x16, 0x08, 0x18, 0x0a, 0x1a, 0x0c, 0x1c, 0x0e, 0x1e))
        )
        ef = shufflevector(
            de, df, Val((0x01, 0x11, 0x03, 0x13, 0x05, 0x15, 0x07, 0x17, 0x09, 0x19, 0x0b, 0x1b, 0x0d, 0x1d, 0x0f, 0x1f))
        )

        vstore(e0, view(B, :, 0x0 + 0x1), 0x1)
        vstore(e1, view(B, :, 0x1 + 0x1), 0x1)
        vstore(e2, view(B, :, 0x2 + 0x1), 0x1)
        vstore(e3, view(B, :, 0x3 + 0x1), 0x1)
        vstore(e4, view(B, :, 0x4 + 0x1), 0x1)
        vstore(e5, view(B, :, 0x5 + 0x1), 0x1)
        vstore(e6, view(B, :, 0x6 + 0x1), 0x1)
        vstore(e7, view(B, :, 0x7 + 0x1), 0x1)
        vstore(e8, view(B, :, 0x8 + 0x1), 0x1)
        vstore(e9, view(B, :, 0x9 + 0x1), 0x1)
        vstore(ea, view(B, :, 0xa + 0x1), 0x1)
        vstore(eb, view(B, :, 0xb + 0x1), 0x1)
        vstore(ec, view(B, :, 0xc + 0x1), 0x1)
        vstore(ed, view(B, :, 0xd + 0x1), 0x1)
        vstore(ee, view(B, :, 0xe + 0x1), 0x1)
        vstore(ef, view(B, :, 0xf + 0x1), 0x1)
    end

    nothing
end

export transposeNxN!
@generated function transposeNxN!(B::DenseMatrix{UInt8}, A::DenseMatrix{UInt8}, ::Val{N}) where {N}
    N::Integer
    @assert ispow2(N)

    stmts = []

    push!(stmts, quote
        @boundscheck begin
            size(A) == ($N, $N) || throw(DimensionMismatch("Matrix A does not have size ($N,$N)"))
            size(B) == ($N, $N) || throw(DimensionMismatch("Matrix B does not have size ($N,$N)"))
            stride(A, 1) == 1 || throw(ArgumentError("Matrix A does not have stride 1 for its first dimension"))
            stride(B, 1) == 1 || throw(ArgumentError("Matrix A does not have stride 1 for its first dimension"))
        end
    end)

    wave = 0

    # Load
    for n in 0:(N - 1)
        an = Symbol(:r, string(wave), :l, string(n))
        push!(stmts, :($an = vload(Vec{$N,UInt8}, view(A, :, $(n+1)), 1)))
    end

    blocksize = Nรท2
    while blocksize > 1
        wave += 1

        for n1 in 0:(2 * blocksize):(N - 1)
            vals = Int[]
            for m1 in 0:(2 * blocksize):(2N - 1)
                for m in m1:(m1 + blocksize - 1)
                    push!(vals, m)
                end
                for m in m1:(m1 + blocksize - 1)
                    push!(vals, m+2*blocksize)
                end
            end
            for n in n1:(n1 + blocksize - 1)
                anlo = Symbol(:r, string(wave-1), :l, string(n))
                anhi = Symbol(:r, string(wave-1), :l, string(n+blocksize))
                bn = Symbol(:r, string(wave), :l, string(n))
                push!(stmts, :($bn = shufflevector($anlo, $anhi, Val(tuple($(vals...))))))
            end
            vals = Int[]
            for m1 in 0:(2 * blocksize):(2N - 1)
                for m in m1:(m1 + blocksize - 1)
                    push!(vals, m+blocksize)
                end
                for m in m1:(m1 + blocksize - 1)
                    push!(vals, m+3*blocksize)
                end
            end
            for n in n1:(n1 + blocksize - 1)
                anlo = Symbol(:r, string(wave-1), :l, string(n))
                anhi = Symbol(:r, string(wave-1), :l, string(n+blocksize))
                bn = Symbol(:r, string(wave), :l, string(n+blocksize))
                push!(stmts, :($bn = shufflevector($anlo, $anhi, Val(tuple($(vals...))))))
            end
        end

        blocksize รท= 2
    end

    # Store
    for n in 0:(N - 1)
        an = Symbol(:r, string(wave), :l, string(n))
        push!(stmts, :(vstore($an, view(B, :, $(n+1)), 1)))
    end

    # Return
    push!(stmts, :(return nothing))

    body = quote
        @inbounds begin
            $(stmts...)
        end
    end

    return body
end

end
